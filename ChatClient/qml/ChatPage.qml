import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15
import Qt.labs.platform 1.1 // Use Qt.labs.platform instead of QtQuick.Dialogs

Rectangle {
    color: theme.backgroundColor

    RowLayout {
        anchors.fill: parent
        spacing: 0

        // Â∑¶‰æßÈù¢Êùø
        Rectangle {
            Layout.preferredWidth: 250
            Layout.fillHeight: true
            color: theme.sidebarColor
            border.color: theme.borderColor
            border.width: 1

            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 10
                spacing: 10

                // Ê∑ªÂä†ËÆæÁΩÆÂíåÁôªÂá∫ÊåâÈíÆ
                RowLayout {
                    Layout.fillWidth: true
                    spacing: 10

                    Button {
                        text: "‰∏™‰∫∫ËµÑÊñô"
                        Layout.fillWidth: true
                        font.pixelSize: 13
                        background: Rectangle {
                            color: parent.pressed ? theme.primaryButtonPressedColor : theme.primaryButtonColor
                            radius: 6
                            border.width: 0
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                            font: parent.font
                        }
                        onClicked: stackView.push(profilePage)
                    }

                    Button {
                        text: "ËÆæÁΩÆ"
                        Layout.fillWidth: true
                        font.pixelSize: 13
                        background: Rectangle {
                            color: parent.pressed ? theme.primaryButtonPressedColor : theme.primaryButtonColor
                            radius: 6
                            border.width: 0
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                            font: parent.font
                        }
                        onClicked: stackView.push(settingsPage)
                    }

                    Button {
                        text: "Áæ§ËÅä"
                        Layout.fillWidth: true
                        font.pixelSize: 13
                        background: Rectangle {
                            color: parent.pressed ? theme.successButtonPressedColor : theme.successButtonColor
                            radius: 6
                            border.width: 0
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                            font: parent.font
                        }
                        onClicked: {
                            chatWindow.refreshGroupList();
                            stackView.push(groupChatPage);
                        }
                    }

                    Button {
                        text: "ÁôªÂá∫"
                        Layout.fillWidth: true
                        font.pixelSize: 13
                        background: Rectangle {
                            color: parent.pressed ? theme.dangerButtonPressedColor : theme.dangerButtonColor
                            radius: 6
                            border.width: 0
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                            font: parent.font
                        }
                        onClicked: {
                            chatWindow.logout();
                        }
                    }
                }

                RowLayout {
                    spacing: 5
                    TextField {
                        id: searchField
                        Layout.fillWidth: true
                        placeholderText: "ÊêúÁ¥¢ÊàñÊ∑ªÂä†Â•ΩÂèã..."
                        font.pixelSize: 13
                        color: theme.primaryTextColor
                        placeholderTextColor: theme.secondaryTextColor
                        background: Rectangle {
                            border.color: searchField.activeFocus ? theme.inputFocusBorderColor : theme.inputBorderColor
                            border.width: 1
                            radius: 15
                            color: theme.inputBackgroundColor
                        }
                    }
                    Button {
                        text: "+"
                        Layout.preferredWidth: 30
                        Layout.preferredHeight: 30
                        font.bold: true
                        background: Rectangle {
                            color: parent.pressed ? theme.primaryButtonPressedColor : theme.primaryButtonColor
                            radius: 15
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                        onClicked: chatWindow.sendFriendRequest(searchField.text)
                    }
                }

                Button {
                    text: "ÊêúÁ¥¢Áî®Êà∑"
                    Layout.fillWidth: true
                    font.pixelSize: 13
                    background: Rectangle {
                        color: parent.pressed ? theme.secondaryButtonPressedColor : theme.secondaryButtonColor
                        radius: 6
                    }
                    contentItem: Text {
                        text: parent.text
                        color: "white"
                        horizontalAlignment: Text.AlignHCenter
                        verticalAlignment: Text.AlignVCenter
                    }
                    onClicked: chatWindow.searchUser(searchField.text)
                }

                FriendList {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    friendModel: chatWindow.friendList
                    requestModel: chatWindow.friendRequests

                    onFriendSelected: function(friendName) {
                        chatWindow.selectFriend(friendName)
                    }

                    onAcceptRequest: function(friendName) {
                        chatWindow.acceptFriendRequest(friendName)
                    }

                    onDeleteRequest: function(friendName) {
                        chatWindow.deleteFriendRequest(friendName)
                    }

                    onDeleteFriend: function(friendName) {
                        chatWindow.deleteFriend(friendName)
                    }
                }
            }
        }

        // Âè≥‰æßËÅäÂ§©Âå∫Âüü
        ColumnLayout {
            Layout.fillWidth: true
            Layout.fillHeight: true
            spacing: 0

            ListView {
                id: messageListView
                Layout.fillWidth: true
                Layout.fillHeight: true
                model: ListModel { id: messageModel }
                delegate: MessageBubble {
                    sender: model.sender
                    content: model.content
                    timestamp: model.timestamp
                    avatarSource: model.avatarSource || ""
                    isOwnMessage: model.sender === chatWindow.currentNickname
                    width: parent.width
                }
                clip: true
                ScrollBar.vertical: ScrollBar {}
                onCountChanged: Qt.callLater(function() {
                    messageListView.positionViewAtEnd();
                })
            }

            Rectangle {
                Layout.fillWidth: true
                Layout.preferredHeight: 60
                color: theme.backgroundColor
                border.color: theme.borderColor
                border.width: 1

                RowLayout {
                    anchors.fill: parent
                    anchors.margins: 10
                    spacing: 10

                    Button {
                        id: imageButton
                        Layout.preferredWidth: 40
                        Layout.preferredHeight: 40

                        background: Rectangle {
                            color: parent.pressed ? "#e0e0e0" : "#f0f0f0"
                            radius: 4
                        }

                        contentItem: Text {
                            text: "üì∑"
                            font.pixelSize: 20
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }

                        onClicked: {
                            imageFileDialog.open();
                        }

                        ToolTip {
                            visible: parent.hovered
                            text: "ÂèëÈÄÅÂõæÁâá"
                            delay: 500
                        }
                    }

                    TextField {
                        id: messageInput
                        Layout.fillWidth: true
                        placeholderText: "ËæìÂÖ•Ê∂àÊÅØ..."
                        font.pixelSize: 14
                        background: Rectangle {
                            border.color: messageInput.activeFocus ? "#80BDFF" : "#CED4DA"
                            border.width: 1
                            radius: 4
                        }
                        Keys.onReturnPressed: {
                            if (text.trim() !== "") {
                                chatWindow.sendMessage(text);
                                text = "";
                            }
                        }
                    }

                    Button {
                        text: "ÂèëÈÄÅ"
                        Layout.preferredWidth: 80
                        font.pixelSize: 14
                        background: Rectangle {
                            color: parent.pressed ? "#0056b3" : "#007BFF"
                            radius: 4
                        }
                        contentItem: Text {
                            text: parent.text
                            color: "white"
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                        onClicked: {
                            if (messageInput.text.trim() !== "") {
                                chatWindow.sendMessage(messageInput.text);
                                messageInput.text = "";
                            }
                        }
                    }
                }
            }
        }
    }

    // ÂõæÁâáÈÄâÊã©ÂØπËØùÊ°Ü
    FileDialog {
        id: imageFileDialog
        title: "ÈÄâÊã©ÂõæÁâá"
        nameFilters: ["ÂõæÁâáÊñá‰ª∂ (*.jpg *.jpeg *.png *.gif)"]
        fileMode: FileDialog.OpenFile

        onAccepted: {
            // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            chatWindow.sendImageMessage(imageFileDialog.file.toString());
        }
    }

    Connections {
        target: chatWindow
        function onMessageReceived(sender, content, timestamp, avatarSource) {
            messageModel.append({
                "sender": sender,
                "content": content,
                "timestamp": timestamp,
                "avatarSource": avatarSource
            });
        }
        function onChatDisplayCleared() {
            messageModel.clear();
        }
        function onImageDownloaded(imageId, localPath) {
            console.log("ÂõæÁâá‰∏ãËΩΩÂÆåÊàêÔºåID:", imageId, "Êú¨Âú∞Ë∑ØÂæÑ:", localPath);
            // ‰∏çÂÜçÈúÄË¶ÅÂà∑Êñ∞Êï¥‰∏™ÂàóË°®ÔºåÊàë‰ª¨‰ºöÈÄöËøáimageMessageUpdated‰ø°Âè∑Êõ¥Êñ∞ÁâπÂÆöÊ∂àÊÅØ
        }

        function onUpdatePlaceholderMessages(imageId, jsonContent) {
            console.log("Êõ¥Êñ∞ÂõæÁâáÂç†‰ΩçÁ¨¶Ê∂àÊÅØÔºåID:", imageId, "ÂÜÖÂÆπ:", jsonContent);

            // Êü•ÊâæÂπ∂Êõ¥Êñ∞ÊâÄÊúâÂåÖÂê´"[ÂõæÁâáÂä†ËΩΩ‰∏≠...]"ÁöÑÊ∂àÊÅØ
            for (var i = 0; i < messageModel.count; i++) {
                var content = messageModel.get(i).content;

                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂç†‰ΩçÁ¨¶Ê∂àÊÅØ
                if (content === "[ÂõæÁâáÂä†ËΩΩ‰∏≠...]") {
                    console.log("ÊâæÂà∞ÂõæÁâáÂç†‰ΩçÁ¨¶Ê∂àÊÅØÔºåÁ¥¢Âºï:", i);

                    // Ëé∑ÂèñÂΩìÂâçÊ∂àÊÅØÁöÑÊâÄÊúâÂ±ûÊÄß
                    var currentMessage = messageModel.get(i);
                    var sender = currentMessage.sender;
                    var timestamp = currentMessage.timestamp;
                    var avatarSource = currentMessage.avatarSource;

                    // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπÔºå‰øùÁïôÂÖ∂‰ªñÂ±ûÊÄß
                    messageModel.set(i, {
                        "sender": sender,
                        "content": jsonContent,
                        "timestamp": timestamp,
                        "avatarSource": avatarSource
                    });
                }
            }

            // Âº∫Âà∂ListViewÂà∑Êñ∞
            messageListView.forceLayout();
        }

        function onImageMessageUpdated(imageId, jsonContent) {
            console.log("Êõ¥Êñ∞ÂõæÁâáÊ∂àÊÅØÔºåID:", imageId, "ÂÜÖÂÆπ:", jsonContent);

            // Êü•ÊâæÂπ∂Êõ¥Êñ∞ÂåÖÂê´ËØ•ÂõæÁâáIDÁöÑÊ∂àÊÅØ
            for (var i = 0; i < messageModel.count; i++) {
                var content = messageModel.get(i).content;

                // Ê£ÄÊü•Ê∂àÊÅØÂÜÖÂÆπÊòØÂê¶ÂåÖÂê´ËØ•ÂõæÁâáID
                if (content.indexOf(imageId) !== -1) {
                    console.log("ÊâæÂà∞ÂåÖÂê´ÂõæÁâáIDÁöÑÊ∂àÊÅØÔºåÁ¥¢Âºï:", i);

                    // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
                    messageModel.set(i, {
                        "content": jsonContent
                    });

                    // Ëé∑ÂèñÂΩìÂâçÊ∂àÊÅØÁöÑÊâÄÊúâÂ±ûÊÄß
                    var currentMessage = messageModel.get(i);
                    var sender = currentMessage.sender;
                    var timestamp = currentMessage.timestamp;
                    var avatarSource = currentMessage.avatarSource;

                    // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπÔºå‰øùÁïôÂÖ∂‰ªñÂ±ûÊÄß
                    messageModel.set(i, {
                        "sender": sender,
                        "content": jsonContent,
                        "timestamp": timestamp,
                        "avatarSource": avatarSource
                    });

                    // Â¶ÇÊûúÊúâÂ§ö‰∏™Ê∂àÊÅØÂåÖÂê´Âêå‰∏Ä‰∏™ÂõæÁâáIDÔºåÁªßÁª≠Êü•Êâæ
                    continue;
                }

                // Â∞ùËØïËß£ÊûêJSONÂÜÖÂÆπ
                try {
                    var contentObj = JSON.parse(content);
                    if (contentObj && contentObj.type === "image" && contentObj.imageId === imageId) {
                        console.log("ÊâæÂà∞ÂåÖÂê´ÂõæÁâáIDÁöÑJSONÊ∂àÊÅØÔºåÁ¥¢Âºï:", i);

                        // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπ
                        messageModel.set(i, {
                            "content": jsonContent
                        });

                        // Ëé∑ÂèñÂΩìÂâçÊ∂àÊÅØÁöÑÊâÄÊúâÂ±ûÊÄß
                        var currentMessage = messageModel.get(i);
                        var sender = currentMessage.sender;
                        var timestamp = currentMessage.timestamp;
                        var avatarSource = currentMessage.avatarSource;

                        // Êõ¥Êñ∞Ê∂àÊÅØÂÜÖÂÆπÔºå‰øùÁïôÂÖ∂‰ªñÂ±ûÊÄß
                        messageModel.set(i, {
                            "sender": sender,
                            "content": jsonContent,
                            "timestamp": timestamp,
                            "avatarSource": avatarSource
                        });
                    }
                } catch (e) {
                    // ‰∏çÊòØJSONÔºåÁªßÁª≠Ê£ÄÊü•‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
                }
            }

            // Âº∫Âà∂ListViewÂà∑Êñ∞
            messageListView.forceLayout();
        }
    }
}